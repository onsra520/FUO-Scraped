<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer - {{ thread_name }}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/" style="color: inherit; text-decoration: none;">
                    <i class="fas fa-spider"></i>
                    <span>FUO Phake</span>
                </a>
            </div>
            <div class="nav-title">
                <span>{{ thread_name }}</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="viewer-content">
        <!-- View Mode Toggle -->
        <div class="viewer-controls">
            <div class="viewer-left-controls">
                <button id="exportPdfBtn" class="control-btn export-btn">
                    <i class="fas fa-file-export"></i>
                    <span>Export PDF</span>
                </button>
            </div>
            
            <div class="viewer-center-controls">
                <button id="prevBtn" class="viewer-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="imageCounter" class="image-counter">1 / 1</span>
                <button id="nextBtn" class="viewer-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="viewer-right-controls">
                <button id="fullscreenBtn" class="icon-btn fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button id="viewerSettingsBtn" class="icon-btn settings-btn" onclick="openViewerSettings()" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Images View -->
        <div id="imagesView" class="images-view">
            <div class="image-container">
                <img id="currentImage" src="" alt="Current Image">
            </div>
        </div>

        <!-- PDF View -->
        <div id="pdfView" class="pdf-view" style="display: none;">
            <iframe id="pdfFrame" src="" frameborder="0"></iframe>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>Đang tải...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Không tìm thấy dữ liệu</h3>
            <p>Thread này chưa có ảnh hoặc PDF.</p>
            <a href="/" class="btn-back">
                <i class="fas fa-arrow-left"></i>
                Về trang chủ
            </a>
        </div>
    </main>

    <!-- Fullscreen Image Overlay -->
    <div id="fullscreenOverlay" class="fullscreen-overlay" style="display: none;">
        <button class="fullscreen-close" onclick="closeImageFullscreen()">
            <i class="fas fa-times"></i>
        </button>
        <button class="fullscreen-nav fullscreen-prev" onclick="fullscreenPrevImage()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="fullscreen-nav fullscreen-next" onclick="fullscreenNextImage()">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div id="fullscreenContent" class="fullscreen-content">
            <img id="fullscreenImage" src="" alt="Fullscreen Image">
        </div>
        <div class="fullscreen-counter" id="fullscreenCounter">1 / 1</div>
    </div>

    <!-- Viewer Settings Modal -->
    <div id="viewerSettingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-cog"></i>
                    Viewer Settings
                </h3>
                <button class="modal-close" onclick="closeViewerSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4 class="settings-section-title">
                        <i class="fas fa-layout"></i>
                        Layout Mode
                    </h4>
                    <div class="layout-grid">
                        <div class="layout-option" data-layout="one-by-one">
                            <div class="layout-preview">
                                <i class="fas fa-square"></i>
                            </div>
                            <div class="layout-info">
                                <strong>One by One</strong>
                                <small>Xem từng ảnh một</small>
                            </div>
                        </div>
                        
                        <div class="layout-option" data-layout="scroll">
                            <div class="layout-preview">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="layout-info">
                                <strong>Scroll</strong>
                                <small>Hiện tất cả để scroll</small>
                            </div>
                        </div>
                        
                        <div class="layout-option" data-layout="grid">
                            <div class="layout-preview">
                                <i class="fas fa-th"></i>
                            </div>
                            <div class="layout-info">
                                <strong>Grid</strong>
                                <small>Lưới 2-3 cột</small>
                            </div>
                        </div>
                        
                        <div class="layout-option" data-layout="slideshow">
                            <div class="layout-preview">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="layout-info">
                                <strong>Slideshow</strong>
                                <small>Tự động chuyển ảnh</small>
                            </div>
                        </div>
                        
                        <div class="layout-option" data-layout="compare">
                            <div class="layout-preview">
                                <i class="fas fa-columns"></i>
                            </div>
                            <div class="layout-info">
                                <strong>Compare</strong>
                                <small>So sánh 2 ảnh cạnh nhau</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section" id="slideshowSettings" style="display: none;">
                    <h4 class="settings-section-title">
                        <i class="fas fa-clock"></i>
                        Slideshow Settings
                    </h4>
                    <div class="modal-setting-item">
                        <div class="setting-label">
                            <strong>Interval (giây)</strong>
                            <small>Thời gian giữa mỗi slide</small>
                        </div>
                        <input type="number" id="slideshowInterval" class="setting-input" min="1" max="10" value="3">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4 class="settings-section-title" style="color: var(--error);">
                        <i class="fas fa-trash-alt"></i>
                        Danger Zone
                    </h4>
                    <div class="modal-setting-item" style="background: rgba(255, 69, 58, 0.1); border: 1px solid var(--error);">
                        <div class="setting-label">
                            <strong style="color: var(--error);">Delete Thread</strong>
                            <small>Permanently delete all images and PDF for this thread</small>
                        </div>
                        <button onclick="deleteThread()" class="delete-thread-btn" style="background: var(--error); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: var(--error);">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirm Delete
                </h3>
                <button class="modal-close" onclick="closeDeleteConfirm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; font-size: 16px;">
                    Are you sure you want to delete <strong id="deleteThreadName"></strong>?
                </p>
                <p style="color: var(--error); margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i>
                    This will permanently delete:
                </p>
                <ul style="margin-bottom: 20px; padding-left: 20px;">
                    <li>All images in the folder</li>
                    <li>PDF file</li>
                    <li>Database record</li>
                </ul>
                <p style="color: var(--text-secondary); font-style: italic;">
                    This action cannot be undone!
                </p>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button onclick="closeDeleteConfirm()" style="flex: 1; padding: 12px; background: var(--bg-tertiary); border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" style="flex: 1; padding: 12px; background: var(--error); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-trash"></i> Delete Forever
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const courseCode = "{{ course_code }}";
        const threadName = "{{ thread_name }}";
        
        function deleteThread() {
            document.getElementById('deleteThreadName').textContent = threadName;
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }
        
        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
        }
        
        async function confirmDelete() {
            try {
                const response = await fetch('/api/thread/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        course_code: courseCode,
                        thread_name: threadName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('Thread deleted successfully!');
                    window.location.href = '/';
                } else if (data.deleted && data.deleted.length > 0) {
                    // Partial deletion - redirect anyway
                    alert('Partial deletion completed. Deleted: ' + data.deleted.join(', ') + '\n\nPlease close this page and manually delete the images folder if it still exists.');
                    window.location.href = '/';
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete thread'));
                    // Still redirect to home
                    window.location.href = '/';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                // Redirect anyway
                window.location.href = '/';
            }
        }
        
        // Close modals on outside click
        window.addEventListener('click', (e) => {
            const deleteModal = document.getElementById('deleteConfirmModal');
            if (e.target === deleteModal) {
                closeDeleteConfirm();
            }
        });
    </script>
    <script src="/static/js/viewer.js?v=5.0"></script>
</body>
</html>
